package com.example.municipalmanage;

import java.util.ArrayList;
import java.util.List;

import com.baidu.location.BDLocation;
import com.baidu.location.BDLocationListener;
import com.baidu.location.BDNotifyListener;
import com.baidu.location.LocationClient;
import com.baidu.location.LocationClientOption;
import com.baidu.location.LocationClientOption.LocationMode;
import com.baidu.mapapi.map.BaiduMap;
import com.baidu.mapapi.map.BitmapDescriptor;
import com.baidu.mapapi.map.MapStatusUpdate;
import com.baidu.mapapi.map.MapStatusUpdateFactory;
import com.baidu.mapapi.map.MapView;
import com.baidu.mapapi.map.MyLocationConfiguration;
import com.baidu.mapapi.map.MyLocationData;
import com.baidu.mapapi.model.LatLng;

import android.app.Activity;
import android.app.LocalActivityManager;
import android.app.ProgressDialog;
import android.app.Service;
import android.content.Intent;
import android.net.Uri;
import android.os.Bundle;
import android.os.Vibrator;
import android.view.View;
import android.view.View.OnClickListener;
import android.widget.AdapterView;
import android.widget.AdapterView.OnItemClickListener;
import android.widget.Button;
import android.widget.ListView;
import android.widget.TabHost;
import android.widget.Toast;

/**
 * 定位
 * 
 * @author ys
 *
 */
public class LocationActivity extends Activity implements OnClickListener {
	// tab切换
	private TabHost tabhost;
	private List<Contact> contactList = new ArrayList<Contact>();

	private MapView mapview;
	private BaiduMap bdMap;

	private LocationClient locationClient;
	private BDLocationListener locationListener;
	private BDNotifyListener notifyListener;

	private double longitude;// 精度
	private double latitude;// 维度
	private float radius;// 定位精度半径，单位是米
	private String addrStr;// 反地理编码
	private float direction;// 手机方向信息

	private int locType;

	// 定位按钮
	private Button locateBtn;
	private Button findQuestion;
	private Button questionList;
	//private Button uploadMaintenance;
	private Button myorder;
	// 定位模式 （普通-跟随-罗盘）
	private MyLocationConfiguration.LocationMode currentMode;
	// 定位图标描述
	private BitmapDescriptor currentMarker = null;

	// 振动器设备
	private Vibrator mVibrator;

	@Override
	protected void onCreate(Bundle savedInstanceState) {
		super.onCreate(savedInstanceState);
		setContentView(R.layout.activity_location);
		mapview = (MapView) findViewById(R.id.bd_mapview);
		mapview.showZoomControls(false);
		bdMap = mapview.getMap();
		locateBtn = (Button) findViewById(R.id.locate_btn);
		findQuestion = (Button) findViewById(R.id.locate_btn2);
		questionList = (Button) findViewById(R.id.locate_btn3);
	//	uploadMaintenance= (Button) findViewById(R.id.locate_btn4);
		myorder=(Button)findViewById(R.id.locate_btn5);
		locateBtn.setOnClickListener(this);
		currentMode = MyLocationConfiguration.LocationMode.NORMAL;
		locateBtn.setText("普通视图");
		mVibrator = (Vibrator) getApplicationContext().getSystemService(Service.VIBRATOR_SERVICE);
		init();

		findQuestion.setOnClickListener(new OnClickListener() {

			@Override
			public void onClick(View v) {
				Intent intent = new Intent(LocationActivity.this, FindQuestionActivity.class);
				intent.putExtra("address", addrStr);
				startActivity(intent);// TODO Auto-generated method stub

			}
		});
		questionList.setOnClickListener(new OnClickListener() {
			
			@Override
			public void onClick(View v) {
				final ProgressDialog progressDialog=new ProgressDialog(LocationActivity.this);
				progressDialog.setTitle("正在加载列表");
				progressDialog.setMessage("Loading...");
				progressDialog.setCancelable(true);
				progressDialog.show();
				new Thread(){
					public void run(){
					try{
					sleep(1000);//最好这里用一个同步线程，监听返回结果，更灵活
					Intent intent = new Intent(LocationActivity.this, QuestionList.class);
					startActivity(intent);
					}
					catch(Exception e)
					{ e.printStackTrace(); }
					progressDialog.dismiss();
					}
					}.start();
				 
			}
		});
		
		myorder.setOnClickListener(new OnClickListener() {
			
			@Override
			public void onClick(View v) {
				final ProgressDialog progressDialog=new ProgressDialog(LocationActivity.this);
				progressDialog.setTitle("正在加载列表");
				progressDialog.setMessage("Loading...");
				progressDialog.setCancelable(true);
				progressDialog.show();
				new Thread(){
					public void run(){
					try{
					sleep(1000);//最好这里用一个同步线程，监听返回结果，更灵活
					Intent intent = new Intent(LocationActivity.this, MyOrder.class);
					startActivity(intent);
					}
					catch(Exception e)
					{ e.printStackTrace(); }
					progressDialog.dismiss();
					}
					}.start();
				
			}
		});
		initContacts();//初始化数据
		ContactAdapter adapter = new ContactAdapter(LocationActivity.this, R.layout.contact_item, contactList);
		ListView listView = (ListView) findViewById(R.id.list_view);
		listView.setAdapter(adapter);
		listView.setOnItemClickListener(new OnItemClickListener() {
			@Override
			public void onItemClick(AdapterView<?> parent, View view, int position, long id) {
				Contact contact=contactList.get(position);
				String number=contact.getPhone_numeber();
				Intent intent = new Intent(Intent.ACTION_CALL,Uri.parse("tel:"+number.trim()));  
                startActivity(intent);  
				
			}
		});

		tabhost = (TabHost) findViewById(android.R.id.tabhost);

		LocalActivityManager lam = new

		LocalActivityManager(LocationActivity.this, false);

		lam.dispatchCreate(savedInstanceState);

		
		tabhost.setup(lam);

		TabHost.TabSpec tab1 = tabhost.newTabSpec("one");
		tab1.setIndicator("地图");
		tab1.setContent(R.id.map);

		TabHost.TabSpec tab2 = tabhost.newTabSpec("two");
		tab2.setIndicator("联系人");
		tab2.setContent(R.id.contact);

		tabhost.addTab(tab1);
		tabhost.addTab(tab2);
		
	}
	

	/**
	 * 
	 */
	private void init() {
		bdMap.setMyLocationEnabled(true);
		// 1. 初始化LocationClient类
		locationClient = new LocationClient(getApplicationContext());
		// 2. 声明LocationListener类
		locationListener = new MyLocationListener();
		// 3. 注册监听函数
		locationClient.registerLocationListener(locationListener);
		// 4. 设置参数
		LocationClientOption locOption = new LocationClientOption();
		locOption.setLocationMode(LocationMode.Hight_Accuracy);// 设置定位模式
		locOption.setCoorType("bd09ll");// 设置定位结果类型
		locOption.setScanSpan(5000);// 设置发起定位请求的间隔时间,ms
		locOption.setIsNeedAddress(true);// 返回的定位结果包含地址信息
		locOption.setNeedDeviceDirect(true);// 设置返回结果包含手机的方向

		locationClient.setLocOption(locOption);
		// 5. 注册位置提醒监听事件
		notifyListener = new MyNotifyListener();
		notifyListener.SetNotifyLocation(longitude, latitude, 3000, "bd09ll");// 精度，维度，范围，坐标类型
		locationClient.registerNotify(notifyListener);
		// 6. 开启/关闭 定位SDK
		locationClient.start();
		// locationClient.stop();
		// 发起定位，异步获取当前位置，因为是异步的，所以立即返回，不会引起阻塞
		// 定位的结果在ReceiveListener的方法onReceive方法的参数中返回。
		// 当定位SDK从定位依据判定，位置和上一次没发生变化，而且上一次定位结果可用时，则不会发生网络请求，而是返回上一次的定位结果。
		// 返回值，0：正常发起了定位 1：service没有启动 2：没有监听函数
		// 6：两次请求时间太短（前后两次请求定位时间间隔不能小于1000ms）
		/*
		 * if (locationClient != null && locationClient.isStarted()) {
		 * requestResult = locationClient.requestLocation(); } else {
		 * Log.d("LocSDK5", "locClient is null or not started"); }
		 */

	}

	/**
	 * 
	 * @author 
	 *
	 */
	class MyLocationListener implements BDLocationListener {
		// 异步返回的定位结果
		@Override
		public void onReceiveLocation(BDLocation location) {
			if (location == null) {
				return;
			}
			longitude = location.getLongitude();
			latitude = location.getLatitude();
			if (location.hasRadius()) {// 判断是否有定位精度半径
				radius = location.getRadius();
			}
             addrStr=location.getAddrStr();
			// 构造定位数据
			MyLocationData locData = new MyLocationData.Builder().accuracy(radius)//
					.direction(direction)// 方向
					.latitude(latitude)//
					.longitude(longitude)//
					.build();
			// 设置定位数据
			bdMap.setMyLocationData(locData);
			LatLng ll = new LatLng(latitude, longitude);
			MapStatusUpdate msu = MapStatusUpdateFactory.newLatLng(ll);
			bdMap.animateMapStatus(msu);
         
		}
	}

	/**
	 * 位置提醒监听器
	 * 
	 * @author
	 *
	 */
	class MyNotifyListener extends BDNotifyListener {
		@Override
		public void onNotify(BDLocation bdLocation, float distance) {
			super.onNotify(bdLocation, distance);
			mVibrator.vibrate(1000);// 振动提醒已到设定位置附近
			Toast.makeText(LocationActivity.this, "震动提醒", Toast.LENGTH_SHORT).show();
		}
	}

	@Override
	public void onClick(View v) {
		switch (v.getId()) {
		case R.id.locate_btn:// 定位
			switch (currentMode) {
			case NORMAL:
				locateBtn.setText("跟随视图");
				currentMode = MyLocationConfiguration.LocationMode.FOLLOWING;
				break;
			case FOLLOWING:
				locateBtn.setText("罗盘视图");
				currentMode = MyLocationConfiguration.LocationMode.COMPASS;
				break;
			case COMPASS:
				locateBtn.setText("普通视图");
				currentMode = MyLocationConfiguration.LocationMode.NORMAL;
				break;
			}
			bdMap.setMyLocationConfigeration(new MyLocationConfiguration(currentMode, true, currentMarker));
			break;
		}
	}

	@Override
	protected void onResume() {
		super.onResume();
		mapview.onResume();
	}

	@Override
	protected void onPause() {
		super.onPause();
		mapview.onPause();
	}

	@Override
	protected void onDestroy() {
		super.onDestroy();
		mapview.onDestroy();
		locationClient.unRegisterLocationListener(locationListener);
		// 取消位置提醒
		locationClient.removeNotifyEvent(notifyListener);
		locationClient.stop();
	}

	public void initContacts() {
		Contact Bob = new Contact("Bob", "123456789");
		Contact Echo = new Contact("Echo", "123456789");
		contactList.add(Bob);
		contactList.add(Echo);

	}

}
